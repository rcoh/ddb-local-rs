# Agent Context for ddb-local-rs

This document provides context for AI agents working on this project.

## Project Overview

A local DynamoDB implementation in Rust for testing. Uses Smithy to generate a server SDK from the AWS DynamoDB model, then implements a subset of operations with an in-memory backend.

## Architecture

```
smithy/              - Smithy model and code generation
  model/main.smithy  - Minimal DynamoDB service definition (GetItem, PutItem)
  smithy-build.json  - Configures rust-server-codegen plugin
  build.gradle.kts   - Generates SDK and copies to server-sdk/

server-sdk/          - Generated Rust server SDK (DO NOT EDIT)
  src/               - Generated by smithy-rs codegen
  Cargo.toml         - Generated package manifest

ddb-local/           - Implementation crate
  src/
    lib.rs           - Public API (DynamoDbLocal builder, client setup)
    backend.rs       - InMemoryDynamoDb implementation
    main.rs          - Standalone server binary
  Cargo.toml         - Package manifest for publishing
  README.md          - Crates.io documentation
```

## Key Concepts

### Code Generation Flow

1. `./gradlew build` runs in `smithy/`
2. Smithy reads `model/main.smithy` and `smithy-build.json`
3. `rust-server-codegen` plugin generates Rust server SDK
4. Generated code is copied to `server-sdk/`
5. `cargo build` compiles everything

**Important**: `server-sdk/` is generated code. Never edit it directly. Changes go in the Smithy model.

### Two Usage Modes

1. **In-memory (no network)**: Uses a custom `HttpClient` that routes requests directly to the service implementation. Zero network overhead. Best for tests.

2. **Network server**: Binds to a TCP port. Can be used by external processes or the AWS CLI.

### Backend Trait

The `DynamoDb` trait in `lib.rs` defines the backend interface. The default implementation is `InMemoryDynamoDb` in `backend.rs`, which stores items in a `HashMap`. Users can implement custom backends.

## Development Workflow

### Making Changes to the API

1. Edit `smithy/model/main.smithy` to add/modify operations
2. Run `./gradlew build` to regenerate `server-sdk/`
3. Update `ddb-local/src/backend.rs` to implement new operations
4. Update `ddb-local/src/lib.rs` to wire up new operations

### Adding a New Operation

See [docs/ADDING_A_NEW_OPERATION.md](docs/ADDING_A_NEW_OPERATION.md) for a detailed step-by-step guide.

Quick summary:

1. Edit `smithy/extract_minimal.py` to add the operation
2. Run `python3 extract_minimal.py > model/main.smithy` in `smithy/`
3. Run `./gradlew build` to regenerate the server SDK
4. Add method to `DynamoDb` trait in `lib.rs`
5. Wire up in `build_service!` macro in `lib.rs`
6. Implement in `backend.rs`

Example: Adding `DeleteItem`

1. Add to `smithy/model/main.smithy`:
```smithy
service DynamoDB_20120810 {
    operations: [GetItem, PutItem, DeleteItem]
}

operation DeleteItem {
    input: DeleteItemInput
    output: DeleteItemOutput
}
```

2. Regenerate: `./gradlew build`

3. Implement in `backend.rs`:
```rust
async fn delete_item(&self, input: input::DeleteItemInput) 
    -> Result<output::DeleteItemOutput, error::DeleteItemError> {
    // implementation
}
```

4. Wire up in `lib.rs` builder methods (search for `.get_item(` to see the pattern)

### Testing

Run tests: `cargo test`

The in-memory backend is tested by creating a client and making actual SDK calls. See `.references/ddb_impl.rs` for test examples.

## Important Files

- `smithy/model/main.smithy` - Service definition (source of truth)
- `ddb-local/src/backend.rs` - Core implementation logic
- `ddb-local/src/lib.rs` - Public API and builder pattern
- `ddb-local/Cargo.toml` - Package metadata for crates.io

## Build System

- **Gradle**: Only for Smithy code generation (`smithy/` subproject)
- **Cargo**: For all Rust compilation and testing
- **Workspace**: `ddb-local` and `server-sdk` are workspace members

The `ddb-local/` directory has no Gradle involvement - it's a pure Rust crate.

## CI/CD

GitHub Actions (`.github/workflows/ci.yml`):
- Generates SDK with Gradle
- Builds and tests with Cargo
- Checks formatting (only `ddb-local`, not generated code)
- Runs clippy
- Verifies generated code is committed

## Common Pitfalls

1. **Don't edit `server-sdk/` directly** - It's regenerated on every build
2. **Run `./gradlew build` after Smithy changes** - Cargo won't pick up model changes
3. **Generated code isn't formatted** - That's expected, don't format it
4. **Edition 2024** - Yes, it exists (released late 2024)

## Dependencies

- Smithy model uses AWS DynamoDB traits from `smithy-aws-traits`
- Server SDK generated by `smithy-rs` codegen-server
- Uses `aws-sdk-dynamodb` for client types and test utilities
- Hyper 0.14 for HTTP server (generated SDK requirement)

## Publishing

The `ddb-local` crate is designed to be published to crates.io. The `server-sdk` is not published separately - it's included as a path dependency.

For publishing, users would reference:
```toml
[dependencies]
ddb-local = "0.1"
```

The generated SDK is an implementation detail.
